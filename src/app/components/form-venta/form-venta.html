<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
      <i class="bi bi-cart-plus me-2"></i>
      Nueva Venta
    </h2>
  </div>

  <!-- Mensajes -->
  <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="bi bi-exclamation-triangle me-2"></i>
    {{ errorMessage }}
    <button type="button" class="btn-close" (click)="errorMessage = ''"></button>
  </div>

  <div *ngIf="successMessage" class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="bi bi-check-circle me-2"></i>
    {{ successMessage }}
    <button type="button" class="btn-close" (click)="successMessage = ''"></button>
  </div>

  <div class="row">
    <!-- Panel izquierdo: Búsqueda de cliente y selección de productos -->
    <div class="col-lg-8">
      <!-- Tarjeta de Información del Cliente -->
      <div class="card mb-4">
        <div class="card-header bg-white">
          <h5 class="mb-0">
            <i class="bi bi-person me-2"></i>
            Información del Cliente
          </h5>
        </div>
        <div class="card-body">
          <!-- Búsqueda de cliente por DNI -->
          <div class="row mb-4">
            <div class="col-md-8">
              <label class="form-label">Buscar Cliente por DNI</label>
              <div class="input-group">
                <input
                  type="text"
                  class="form-control"
                  [(ngModel)]="dniBusqueda"
                  placeholder="Ingrese DNI del cliente"
                  maxlength="8"
                  (keyup.enter)="buscarCliente()">
                <button
                  type="button"
                  class="btn btn-primary"
                  (click)="buscarCliente()"
                  [disabled]="isBuscandoCliente || !dniBusqueda || dniBusqueda.length !== 8">
                  <span *ngIf="isBuscandoCliente" class="spinner-border spinner-border-sm me-2"></span>
                  <i *ngIf="!isBuscandoCliente" class="bi bi-search me-2"></i>
                  {{ isBuscandoCliente ? 'Buscando...' : 'Buscar' }}
                </button>
                <button
                  type="button"
                  class="btn btn-outline-secondary"
                  (click)="limpiarBusquedaCliente()">
                  <i class="bi bi-x-circle"></i>
                </button>
              </div>
              <div class="form-text">
                Ingrese el DNI del cliente (8 dígitos) y presione Buscar o Enter
              </div>
            </div>
            
            <!-- MÉTODO DE PAGO SEPARADO -->
            <div class="col-md-4">
              <label for="tipoPago" class="form-label">Método de Pago *</label>
              <select
                class="form-select"
                id="tipoPago"
                [value]="metodoPagoSeleccionado"
                (change)="actualizarMetodoPago($event)">
                <option *ngFor="let tipo of tiposPago" [value]="tipo" [selected]="tipo === 'EFECTIVO'">
                  {{ tipo }}
                </option>
              </select>
            </div>
          </div>

          <!-- Información del cliente -->
          <div *ngIf="clienteExistente || mostrarFormCliente" class="border rounded p-3 bg-light">
            <h6 class="mb-3">
              <i class="bi bi-person-badge me-2"></i>
              {{ clienteExistente ? 'Cliente Encontrado' : 'Registrar Nuevo Cliente' }}
            </h6>
            
            <form [formGroup]="ventaForm">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Nombre Completo *</label>
                  <input
                    type="text"
                    class="form-control"
                    [class.is-invalid]="clienteNombre?.invalid && clienteNombre?.touched"
                    formControlName="clienteNombre"
                    [readonly]="!!clienteExistente"
                    placeholder="Nombre del cliente">
                  <div *ngIf="clienteNombre?.invalid && clienteNombre?.touched" class="invalid-feedback">
                    El nombre del cliente es requerido
                  </div>
                </div>

                <div class="col-md-6 mb-3">
                  <label class="form-label">DNI *</label>
                  <input
                    type="text"
                    class="form-control"
                    [class.is-invalid]="clienteDni?.invalid && clienteDni?.touched"
                    formControlName="clienteDni"
                    [readonly]="!!clienteExistente"
                    placeholder="DNI del cliente"
                    maxlength="8">
                  <div *ngIf="clienteDni?.invalid && clienteDni?.touched" class="invalid-feedback">
                    <span *ngIf="clienteDni?.errors?.['required']">El DNI es requerido</span>
                    <span *ngIf="clienteDni?.errors?.['minlength'] || clienteDni?.errors?.['maxlength']">El DNI debe tener 8 dígitos</span>
                  </div>
                </div>

                <div class="col-md-6 mb-3">
                  <label class="form-label">Correo Electrónico</label>
                  <input
                    type="email"
                    class="form-control"
                    [class.is-invalid]="clienteCorreo?.invalid && clienteCorreo?.touched"
                    formControlName="clienteCorreo"
                    [readonly]="!!clienteExistente"
                    placeholder="correo@ejemplo.com">
                  <div *ngIf="clienteCorreo?.invalid && clienteCorreo?.touched" class="invalid-feedback">
                    <span *ngIf="clienteCorreo?.errors?.['email']">Formato de correo inválido</span>
                  </div>
                </div>

                <div class="col-md-6 mb-3">
                  <label class="form-label">Teléfono</label>
                  <input
                    type="text"
                    class="form-control"
                    [class.is-invalid]="clienteTelefono?.invalid && clienteTelefono?.touched"
                    formControlName="clienteTelefono"
                    [readonly]="!!clienteExistente"
                    placeholder="987654321"
                    maxlength="9">
                  <div *ngIf="clienteTelefono?.invalid && clienteTelefono?.touched" class="invalid-feedback">
                    <span *ngIf="clienteTelefono?.errors?.['minlength'] || clienteTelefono?.errors?.['maxlength']">El teléfono debe tener 9 dígitos</span>
                    <span *ngIf="clienteTelefono?.errors?.['pattern']">Solo se permiten números</span>
                  </div>
                  <div class="form-text">Ejemplo: 987654321 (9 dígitos)</div>
                </div>

                <div class="col-12 mb-3">
                  <label class="form-label">Dirección</label>
                  <textarea
                    class="form-control"
                    formControlName="clienteDireccion"
                    [readonly]="!!clienteExistente"
                    rows="2"
                    placeholder="Dirección del cliente"></textarea>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Selección de Productos -->
      <div class="card">
        <div class="card-header bg-white">
          <h5 class="mb-0">
            <i class="bi bi-cart me-2"></i>
            Seleccionar Productos
          </h5>
        </div>
        <div class="card-body">
          <!-- Filtros -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Filtrar por Categoría</label>
              <select class="form-select" (change)="filtrarProductosPorCategoria($event)">
                <option value="">Todas las categorías</option>
                <option *ngFor="let categoria of categorias" [value]="categoria.id">
                  {{ categoria.nombre }}
                </option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Buscar Producto</label>
              <input
                type="text"
                class="form-control"
                placeholder="Nombre del producto..."
                (input)="filtrarProductosPorNombre($event)">
            </div>
          </div>

          <!-- Lista de productos disponibles con botones +/- -->
          <div class="productos-grid">
            <div *ngFor="let producto of productosFiltrados" 
                 class="producto-card border rounded p-3 mb-3">
              <div class="row align-items-center">
                <div class="col-md-6">
                  <h6 class="mb-1">{{ producto.nombre }}</h6>
                  <small class="text-muted">
                    Categoría: {{ getCategoriaNombre(producto.categoriaId) }} | 
                    Stock: {{ producto.cantidad }}
                  </small>
                  <div class="mt-1">
                    <strong class="text-primary">S/. {{ producto.precioVenta | number:'1.2-2' }}</strong>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="input-group">
                    <button class="btn btn-outline-secondary" 
                            type="button"
                            (click)="decrementarCantidad(producto)"
                            [disabled]="getCantidadSeleccionada(producto.id) <= 0">
                      <i class="bi bi-dash"></i>
                    </button>
                    <input
                      type="number"
                      class="form-control text-center"
                      [value]="getCantidadSeleccionada(producto.id)"
                      min="0"
                      [max]="producto.cantidad"
                      (change)="actualizarCantidad(producto, $event)"
                      style="max-width: 80px;">
                    <button class="btn btn-outline-secondary" 
                            type="button"
                            (click)="incrementarCantidad(producto)"
                            [disabled]="getCantidadSeleccionada(producto.id) >= producto.cantidad">
                      <i class="bi bi-plus"></i>
                    </button>
                  </div>
                </div>
                <div class="col-md-2">
                  <button class="btn btn-success w-100"
                          (click)="agregarProductoAlCarrito(producto)"
                          [disabled]="getCantidadSeleccionada(producto.id) <= 0 || getCantidadSeleccionada(producto.id) > producto.cantidad">
                    <i class="bi bi-cart-plus"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Mensaje cuando no hay productos -->
          <div *ngIf="productosFiltrados.length === 0" class="text-center py-4 text-muted">
            <i class="bi bi-search display-4 d-block mb-2"></i>
            <p>No se encontraron productos</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Panel derecho: Resumen de venta -->
    <div class="col-lg-4">
      <div class="card sticky-top">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="bi bi-receipt me-2"></i>
            Resumen de Venta
          </h5>
        </div>
        <div class="card-body">
          <!-- Productos en el carrito -->
          <div class="mb-3">
            <h6>Productos en la Venta</h6>
            <div class="productos-carrito" style="max-height: 300px; overflow-y: auto;">
              <div *ngFor="let detalle of detalles.controls; let i = index" 
                   class="producto-carrito-item border-bottom pb-2 mb-2">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="flex-grow-1">
                    <strong class="d-block small">{{ getProductoNombre(detalle.get('productoId')?.value) }}</strong>
                    <small class="text-muted">
                      {{ detalle.get('cantidad')?.value }} x S/. {{ detalle.get('precioUnitario')?.value | number:'1.2-2' }}
                    </small>
                  </div>
                  <div class="text-end">
                    <strong class="text-success d-block">
                      S/. {{ detalle.get('subtotal')?.value | number:'1.2-2' }}
                    </strong>
                    <button class="btn btn-sm btn-outline-danger mt-1"
                            (click)="eliminarDetalle(i)">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div *ngIf="detalles.length === 0" class="text-center py-3 text-muted">
              <i class="bi bi-cart-x d-block mb-2"></i>
              <small>No hay productos en la venta</small>
            </div>
          </div>

          <!-- Totales -->
          <div class="mb-3">
            <div class="d-flex justify-content-between mb-2">
              <span>Subtotal:</span>
              <strong>S/. {{ getTotalVenta() | number:'1.2-2' }}</strong>
            </div>
            
            <div class="d-flex justify-content-between mb-2">
              <span>IGV (18%):</span>
              <strong>S/. {{ getIGV() | number:'1.2-2' }}</strong>
            </div>
            
            <hr>
            
            <div class="d-flex justify-content-between mb-3">
              <span class="h5">Total:</span>
              <strong class="h5 text-primary">S/. {{ getTotalConIGV() | number:'1.2-2' }}</strong>
            </div>
          </div>

          <!-- Información del cliente -->
          <div *ngIf="clienteExistente || mostrarFormCliente" class="mb-3 p-2 bg-light rounded">
            <h6 class="mb-2">
              <i class="bi bi-person me-1"></i>
              Cliente
            </h6>
            <small class="d-block">
              <strong>Nombre:</strong> {{ getClienteNombre() }}
            </small>
            <small class="d-block">
              <strong>DNI:</strong> {{ getClienteDni() }}
            </small>
            <small *ngIf="clienteExistente" class="text-success">
              <i class="bi bi-check-circle me-1"></i>Cliente registrado
            </small>
            <small *ngIf="!clienteExistente && mostrarFormCliente" class="text-warning">
              <i class="bi bi-info-circle me-1"></i>Nuevo cliente
            </small>
          </div>

          <!-- Método de pago  -->
          <div class="mb-3 p-2 bg-light rounded">
            <h6 class="mb-2">
              <i class="bi bi-credit-card me-1"></i>
              Método de Pago
            </h6>
            <small class="d-block">
              <strong>Tipo:</strong> {{ metodoPagoSeleccionado }}
            </small>
          </div>

          <button
            type="button"
            class="btn btn-success w-100 btn-lg"
            (click)="onSubmit()"
            [disabled]="!esFormularioValido() || isLoading">
            <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2"></span>
            <i *ngIf="!isLoading" class="bi bi-credit-card me-2"></i>
            {{ isLoading ? 'Procesando...' : 'Realizar Venta' }}
          </button>

          <!-- Validaciones -->
          <div *ngIf="!esFormularioValido()" class="mt-3">
            <div class="alert alert-warning small">
              <i class="bi bi-exclamation-triangle me-1"></i>
              <strong>Para continuar:</strong>
              <ul class="mb-0 mt-1">
                <li *ngIf="!clienteExistente && !mostrarFormCliente">• Busque un cliente por DNI</li>
                <li *ngIf="detalles.length === 0">• Agregue al menos un producto</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>